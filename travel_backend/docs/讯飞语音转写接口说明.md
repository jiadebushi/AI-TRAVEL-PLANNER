# 讯飞实时语音转写接口说明

## 概述

为了安全地使用讯飞实时语音转写服务，API key 保存在后端，前端通过后端接口获取已鉴权的 WebSocket URL。

## 接口说明

### 1. 获取讯飞 WebSocket URL

**接口**: `GET /api/v1/voice/xunfei/ws-url`

**说明**: 获取已鉴权的讯飞实时语音转写 WebSocket URL

**请求头**: 
```
Authorization: Bearer <access_token>
```

**请求参数**: 无

**响应示例** (200 OK):
```json
{
  "ws_url": "wss://rtasr.xfyun.cn/v1/ws?appid=xxx&ts=1234567890&signa=xxx&lang=cn",
  "expires_in": 300
}
```

**字段说明**:
- `ws_url`: 已鉴权的 WebSocket URL，包含所有必要的认证参数
- `expires_in`: URL 有效期（秒），建议在有效期内使用

**错误响应**:
- `401 Unauthorized`: Token无效或过期
- `500 Internal Server Error`: 生成URL失败
  ```json
  {
    "detail": "生成WebSocket URL失败: 错误信息"
  }
  ```

## 前端使用流程

1. **获取 WebSocket URL**
   - 前端调用 `GET /api/v1/voice/xunfei/ws-url` 获取已鉴权的 URL
   - 该 URL 包含 appid、timestamp、signa 等认证参数

2. **建立 WebSocket 连接**
   - 使用获取到的 `ws_url` 建立 WebSocket 连接
   - 连接地址格式：`wss://rtasr.xfyun.cn/v1/ws?appid=xxx&ts=xxx&signa=xxx&lang=cn`

3. **发送音频数据**
   - 连接建立后，发送 PCM 格式的音频数据（16kHz, 16bit, 单声道）
   - 建议每 40ms 发送 1280 字节

4. **接收转写结果**
   - 服务端返回 JSON 格式的转写结果
   - 解析 `data` 字段获取识别文本

5. **结束识别**
   - 发送 `{"end": true}` 结束识别
   - 服务端关闭连接

## 后端实现要求

### 签名生成算法

1. **生成 baseString**
   ```
   baseString = appid + ts
   ```

2. **MD5 加密**
   ```
   md5Hash = MD5(baseString)
   ```

3. **HMAC-SHA1 加密并 Base64 编码**
   ```
   signa = Base64(HMAC-SHA1(md5Hash, apiKey))
   ```

### 示例代码（Python）

```python
import hashlib
import hmac
import base64
import time

def generate_xunfei_signa(appid: str, api_key: str) -> tuple[str, str]:
    """生成讯飞签名和WebSocket URL"""
    # 1. 生成时间戳
    ts = str(int(time.time()))
    
    # 2. 生成 baseString
    base_string = appid + ts
    
    # 3. MD5 加密
    md5_hash = hashlib.md5(base_string.encode('utf-8')).hexdigest()
    
    # 4. HMAC-SHA1 加密
    hmac_sha1 = hmac.new(
        api_key.encode('utf-8'),
        md5_hash.encode('utf-8'),
        hashlib.sha1
    ).digest()
    
    # 5. Base64 编码
    signa = base64.b64encode(hmac_sha1).decode('utf-8')
    
    # 6. 构建 WebSocket URL
    params = {
        'appid': appid,
        'ts': ts,
        'signa': signa,
        'lang': 'cn'  # 中文
    }
    query_string = '&'.join([f'{k}={v}' for k, v in params.items()])
    ws_url = f'wss://rtasr.xfyun.cn/v1/ws?{query_string}'
    
    return ws_url, ts
```

## 安全说明

1. **API Key 保护**: API key 仅保存在后端，不会暴露给前端
2. **URL 有效期**: 生成的 URL 有时效性，建议在 5 分钟内使用
3. **Token 验证**: 前端需要提供有效的 JWT token 才能获取 URL
4. **HTTPS/WSS**: 生产环境必须使用 WSS（WebSocket Secure）协议

## 注意事项

1. **音频格式要求**:
   - 采样率：16kHz
   - 位深度：16bit
   - 声道：单声道
   - 格式：PCM

2. **发送频率**:
   - 建议每 40ms 发送 1280 字节
   - 发送过快可能导致引擎出错
   - 超过 15 秒未发送数据，服务端会断开连接

3. **错误处理**:
   - 连接失败时，前端应提示用户重试
   - 识别错误时，检查错误码并给出相应提示

