# ⚙️ AI 智能旅行规划项目 - 后端设计文档

基于 Python (FastAPI/Django) 后端、Supabase/Firestore 数据库，结合 LLM 和 API 服务。

## 1. 核心数据模型定义 (数据库 / Pydantic Schema)

| 模型名称 | 用途 | 关键字段 (数据库 Schema) | 备注 |
| :--- | :--- | :--- | :--- |
| `User` | 用户认证与信息 | `user_id` (PK), `email`, `hashed_password`, `preferences` (JSON/Text) | 存储用户偏好，供 LLM 参考。 |
| `TripHeader` | 行程概要 | `trip_id` (PK), `user_id` (FK), `trip_name`, `destination`, `start_date`, `end_date`, `status` | 记录行程的基本信息。 |
| `TripDetail` | 详细行程 (每日) | `detail_id` (PK), `trip_id` (FK), `day_number`, `theme`, `activities` (JSONB/Map) | `activities` 字段存储 LLM 生成的详细活动列表。 |
| `Budget` | 预算估算 | `budget_id` (PK), `trip_id` (FK), `estimated_total`, `categories` (JSONB/Map) | LLM 生成的预算细分数据。 |
| `Expense` | 实际开销 | `expense_id` (PK), `trip_id` (FK), `category`, `amount`, `currency`, `description`, `timestamp` | 记录用户输入的实际开销。 |

## 2. API 接口设计与后端函数

所有 API 接口均需通过 JWT/Token 进行用户认证。

### A. 认证与用户管理 (`/api/v1/auth`, `/api/v1/users`)

| 接口 (FastAPI 风格) | 描述 | 请求体 (`Request Model`) | 响应体 (`Response Model`) | 关键后端函数 (Python) |
| :--- | :--- | :--- | :--- | :--- |
| `POST /auth/register` | 用户注册 | `email`, `password` | `user_id`, `email` | `register_user(email, password)` |
| `POST /auth/login` | 用户登录 | `email`, `password` | `access_token` | `authenticate_user(email, password)` |
| `GET /users/me` | 获取当前用户信息 | N/A (从 Token 解析) | `user_id`, `email`, `preferences`,`create_time`,`update_time` | `get_current_user(token)` |
| `PUT /users/me` | 修改用户偏好 | `UserPreferencesUpdate` | `message: "Preferences updated"` | update_user_preferences(user_id, preferences) |

**关键后端函数 (Python)**

| **层级**   | **文件**                   | **关键功能方法 (Python)**                               | **职责**                                                     |
| ---------- | -------------------------- | ------------------------------------------------------- | ------------------------------------------------------------ |
| **服务层** | `services/user_service.py` | `update_user_preferences(user_id: str, new_prefs: str)` | 验证偏好数据的合法性，并调用数据层更新。                     |
| **数据层** | `data/user_repository.py`  | `update_user_preferences(user_id: str, data: str)`      | 执行数据库操作，将新的偏好数据持久化到 `User` 表的 `preferences` 字段。 |



### B. 智能行程规划 (`/api/v1/plan`)

| 接口 (FastAPI 风格) | 描述 | 请求体 (`Request Model`) | 响应体 (`Response Model`) | 关键后端函数 (Python) |
| :--- | :--- | :--- | :--- | :--- |
| `POST /plan/voice` | 语音输入行程需求 | `audio_file` (文件/Base64) | `trip_id`, `message: "Processing..."` | `handle_voice_input(file)` |
| `POST /plan/text` | 文本输入行程需求 | `TripInput` (见下方 Pydantic) | `trip_id`, `message: "Processing..."` | `create_initial_plan(data)` |
| `GET /plan/{trip_id}` | 获取行程详情 | N/A | `TripDetail` + `TripHeader` | `get_trip_details(trip_id)` |
| `PUT /plan/{trip_id}` | 修改行程 (可选) | 修改后的行程 JSON | `message: "Updated"` | `update_trip_details(trip_id, data)` |

**关键规划函数流程:**

| 关键后端函数 | 描述 | 核心步骤 |
| :--- | :--- | :--- |
| `process_voice(file)` | 语音处理主流程 (2.1-2.2) | 1. 科大讯飞 → 文本。 2. LLM (意图解析) → `TripInput`。 3. 调用 `generate_full_itinerary`。 |
| `generate_full_itinerary(user_input)` | 行程规划主流程 (3.1-3.4) | 1. 地图 API (POI 检索)。 2. LLM (行程决策, 3.2)。 3. 地图 API (耗时预估, 3.3)。 4. 存储 `TripHeader` 和 `TripDetail`。 5. 调用 `estimate_budget`。 |
| `get_poi_and_eta(poi_list, mode)` | 批量获取 POI 坐标和耗时 (3.1, 3.3) | 调用高德/百度地理编码获取坐标；调用路线规划 API 获取两点间预估耗时。 |

### C. 费用预算与管理 (`/api/v1/budget`)

| 接口 (FastAPI 风格) | 描述 | 请求体 (`Request Model`) | 响应体 (`Response Model`) | 关键后端函数 (Python) |
| :--- | :--- | :--- | :--- | :--- |
| `GET /budget/{trip_id}` | 获取预算与开销 | N/A | `Budget`, `Expense` List | `get_trip_finance(trip_id)` |
| `POST /budget/expense/text` | 文本录入开销 | `trip_id`, `text_input` | `Expense` object | `record_expense_text(data)` |
| `POST /budget/expense/voice` | 语音录入开销 | `trip_id`, `audio_file` | `Expense` object | `record_expense_voice(data)` |

**关键财务函数流程:**

| 关键后端函数 | 描述 | 核心步骤 |
| :--- | :--- | :--- |
| `estimate_budget(trip_id, trip_details)` | 预算估算 (4.1) | 1. LLM (预算估算 Prompt) → 结构化预算。 2. 存储到 `Budget` 表。 |
| `process_expense_voice(file)` | 语音开销录入 (4.2) | 1. 科大讯飞 → 文本。 2. LLM (意图解析) → 结构化费用数据。 3. 存储到 `Expense` 表。 |

## 3. 数据格式示例 (Pydantic 风格)

```python
from pydantic import BaseModel
from datetime import date
from typing import List, Optional

# C.1 行程需求输入 (用于 POST /plan/text)
class TripInput(BaseModel):
    destination: str
    start_date: date
    end_date: date
    budget_cny: float
    people: str  # e.g., "2大1小"
    preferences: str  # e.g., "喜欢美食和动漫"

# C.2 详细行程活动 (用于 TripDetail 表的 activities 字段)
class TransportSegment(BaseModel):
    mode: str  # 交通方式: "地铁", "步行", "打车"
    recommendation: str # LLM推荐理由
    next_poi_id: Optional[str] = None # 下一个POI的ID

class Activity(BaseModel):
    poi_id: str
    poi_name: str
    latitude: float
    longitude: float
    estimated_time_slot: str  # e.g., "9:30 - 12:30"
    estimated_duration_minutes: int  # 来自地图 API 3.3
    notes: str
    transport_to_next: Optional[TransportSegment] = None

class DailyPlan(BaseModel):
    day: int
    theme: str
    activities: List[Activity]

# C.3 预算估算结构 (用于 Budget 表的 categories 字段)
class BudgetCategory(BaseModel):
    name: str  # e.g., "住宿", "餐饮", "交通", "门票"
    estimated_cny: float

class TripBudget(BaseModel):
    trip_id: str
    estimated_total_cny: float
    categories: List[BudgetCategory]
    
class UserPreferencesUpdate(BaseModel):
    # 接收一段自由格式的文本，描述用户的旅行偏好
    preferences: str
    
    # 可以在此处添加其他可更新的字段
    # username: Optional[str] = None