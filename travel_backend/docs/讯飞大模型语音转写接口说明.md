# 讯飞实时语音转写大模型接口说明

## 概述

为了安全地使用讯飞实时语音转写大模型服务，API key 保存在后端，前端通过后端接口获取已鉴权的 WebSocket URL。

## 接口说明

### 1. 获取讯飞大模型 WebSocket URL

**接口**: `GET /api/v1/voice/xunfei-llm/ws-url`

**说明**: 获取已鉴权的讯飞实时语音转写大模型 WebSocket URL

**请求头**: 
```
Authorization: Bearer <access_token>
```

**请求参数**: 无

**响应示例** (200 OK):
```json
{
  "ws_url": "wss://office-api-ast-dx.iflyaisol.com/ast/communicate/v1?accessKeyId=xxx&appId=xxx&uuid=xxx&utc=2025-09-04T15%3A38%3A07%2B0800&audio_encode=pcm_s16le&lang=autodialect&samplerate=16000&signature=xxx",
  "session_id": "d49ddd6f-c451-35ea-b8c4-2c75af837caa",
  "expires_in": 300
}
```

**字段说明**:
- `ws_url`: 已鉴权的 WebSocket URL，包含所有必要的认证参数
- `session_id`: 会话ID，用于结束识别时发送结束标识
- `expires_in`: URL 有效期（秒），建议在有效期内使用

**错误响应**:
- `401 Unauthorized`: Token无效或过期
- `500 Internal Server Error`: 生成URL失败
  ```json
  {
    "detail": "生成WebSocket URL失败: 错误信息"
  }
  ```

## 前端使用流程

1. **获取 WebSocket URL**
   - 前端调用 `GET /api/v1/voice/xunfei-llm/ws-url` 获取已鉴权的 URL
   - 该 URL 包含 appId、accessKeyId、utc、signature 等认证参数

2. **建立 WebSocket 连接**
   - 使用获取到的 `ws_url` 建立 WebSocket 连接
   - 连接地址格式：`wss://office-api-ast-dx.iflyaisol.com/ast/communicate/v1?{参数}`

3. **发送音频数据**
   - 连接建立后，发送 PCM 格式的音频数据（16kHz, 16bit, 单声道）
   - 建议每 40ms 发送 1280 字节

4. **接收转写结果**
   - 服务端返回 JSON 格式的转写结果
   - 解析 `data` 字段获取识别文本

5. **结束识别**
   - 发送 `{"end": true, "sessionId": "xxx"}` 结束识别（需要包含 sessionId）
   - 服务端关闭连接

## 后端实现要求

### 签名生成算法

1. **准备参数**
   - `appId`: 应用ID
   - `accessKeyId`: 访问密钥ID
   - `accessKeySecret`: 访问密钥（用于签名，不暴露给前端）
   - `uuid`: 自定义字段（可选，用于标识用户）
   - `utc`: 当前时间，格式：`2025-09-04T15:38:07+0800`（需要URL编码）
   - `audio_encode`: 音频编码格式，如 `pcm_s16le`
   - `lang`: 语言类型，如 `autodialect`（中英+202种方言）或 `autominor`（37个语种）
   - `samplerate`: 采样率，如 `16000`

2. **生成 baseString**
   - 将所有请求参数（不包含 signature）按参数名进行升序排序
   - 对每个参数的键和值分别进行 URL 编码
   - 按照 "编码后的键=编码后的值&" 的格式拼接所有参数
   - 移除最后一个多余的 "&" 符号，得到 baseString

3. **生成签名**
   - 以 `accessKeySecret` 为密钥，对 baseString 进行 HmacSHA1 加密
   - 对加密后的字节数组进行 Base64 编码，得到最终的 signature

4. **构建 WebSocket URL**
   - 将所有参数（包括 signature）拼接成查询字符串
   - 构建完整的 WebSocket URL

### 示例代码（Python）

```python
import hashlib
import hmac
import base64
import time
from datetime import datetime
from urllib.parse import quote
import uuid as uuid_lib

def generate_xunfei_llm_ws_url(
    app_id: str, 
    access_key_id: str, 
    access_key_secret: str,
    uuid: str = None
) -> tuple[str, str]:
    """生成讯飞大模型签名和WebSocket URL"""
    
    # 1. 生成时间戳（UTC格式）
    now = datetime.now()
    utc_str = now.strftime('%Y-%m-%dT%H:%M:%S+0800')
    utc_encoded = quote(utc_str, safe='')
    
    # 2. 生成UUID（如果没有提供）
    if not uuid:
        uuid = str(uuid_lib.uuid4())
    
    # 3. 准备所有参数（不包含signature）
    params = {
        'accessKeyId': access_key_id,
        'appId': app_id,
        'audio_encode': 'pcm_s16le',
        'lang': 'autodialect',  # 中英+202种方言
        'samplerate': '16000',
        'utc': utc_str,  # 未编码的版本用于签名
        'uuid': uuid,
    }
    
    # 4. 按参数名升序排序
    sorted_params = sorted(params.items())
    
    # 5. 构建 baseString（需要对键和值进行URL编码）
    base_string_parts = []
    for key, value in sorted_params:
        encoded_key = quote(key, safe='')
        encoded_value = quote(str(value), safe='')
        base_string_parts.append(f"{encoded_key}={encoded_value}")
    base_string = '&'.join(base_string_parts)
    
    # 6. HMAC-SHA1 加密
    hmac_sha1 = hmac.new(
        access_key_secret.encode('utf-8'),
        base_string.encode('utf-8'),
        hashlib.sha1
    ).digest()
    
    # 7. Base64 编码
    signature = base64.b64encode(hmac_sha1).decode('utf-8')
    signature_encoded = quote(signature, safe='')
    
    # 8. 构建完整的查询字符串（所有参数都需要URL编码）
    query_params = {
        'accessKeyId': access_key_id,
        'appId': app_id,
        'audio_encode': 'pcm_s16le',
        'lang': 'autodialect',
        'samplerate': '16000',
        'utc': utc_encoded,  # 使用编码后的版本
        'uuid': uuid,
        'signature': signature_encoded,
    }
    query_string = '&'.join([f'{quote(k, safe="")}={quote(str(v), safe="")}' for k, v in sorted(query_params.items())])
    
    # 9. 构建 WebSocket URL
    ws_url = f'wss://office-api-ast-dx.iflyaisol.com/ast/communicate/v1?{query_string}'
    
    # 10. 生成 sessionId（用于结束识别）
    session_id = str(uuid_lib.uuid4())
    
    return ws_url, session_id
```

### 配置管理

后端需要配置以下密钥信息（建议使用环境变量或配置文件）：

#### 环境变量配置

```bash
# .env 文件或环境变量
XUNFEI_LLM_APP_ID=your_app_id
XUNFEI_LLM_ACCESS_KEY_ID=your_access_key_id
XUNFEI_LLM_ACCESS_KEY_SECRET=your_access_key_secret  # 敏感信息，不要暴露
```

#### Python 配置示例

```python
import os

# 从环境变量读取配置
XUNFEI_LLM_APP_ID = os.getenv('XUNFEI_LLM_APP_ID')
XUNFEI_LLM_ACCESS_KEY_ID = os.getenv('XUNFEI_LLM_ACCESS_KEY_ID')
XUNFEI_LLM_ACCESS_KEY_SECRET = os.getenv('XUNFEI_LLM_ACCESS_KEY_SECRET')

# 或者使用配置文件（不推荐将密钥写入代码）
# config.py
XUNFEI_LLM_APP_ID = "your_app_id"
XUNFEI_LLM_ACCESS_KEY_ID = "your_access_key_id"
XUNFEI_LLM_ACCESS_KEY_SECRET = "your_access_key_secret"
```

#### 获取密钥信息

1. 登录 [讯飞开放平台控制台](https://console.xfyun.cn/services/rta_new)
2. 创建应用或选择已有应用
3. 在应用管理页面获取：
   - `appId`: 应用ID
   - `accessKeyId`: 访问密钥ID
   - `accessKeySecret`: 访问密钥（敏感信息，妥善保管）

#### 安全建议

1. **不要将密钥提交到代码仓库**
   - 使用 `.env` 文件（已添加到 `.gitignore`）
   - 或使用环境变量
   - 或使用密钥管理服务（如 AWS Secrets Manager、Azure Key Vault 等）

2. **生产环境配置**
   - 使用环境变量或配置管理服务
   - 定期轮换密钥
   - 限制密钥的访问权限

3. **开发环境配置**
   - 使用 `.env` 文件
   - 不要将 `.env` 文件提交到版本控制
   - 团队成员各自配置自己的密钥

## 安全说明

1. **API Key 保护**: `accessKeySecret` 仅保存在后端，不会暴露给前端
2. **URL 有效期**: 生成的 URL 有时效性，建议在 5 分钟内使用
3. **Token 验证**: 前端需要提供有效的 JWT token 才能获取 URL
4. **HTTPS/WSS**: 生产环境必须使用 WSS（WebSocket Secure）协议

## 注意事项

1. **音频格式要求**:
   - 采样率：16kHz 或 8kHz
   - 位深度：16bit
   - 声道：单声道
   - 格式：PCM (pcm_s16le) 或 Opus (opus-wb) 或 Speex (speex-7, speex-10)

2. **发送频率**:
   - 建议每 40ms 发送 1280 字节
   - 发送过快可能导致引擎出错
   - 超过 15 秒未发送数据，服务端会断开连接

3. **语言支持**:
   - `autodialect`: 中英 + 202种方言免切识别
   - `autominor`: 37个语种免切识别（需联系人工对接）

4. **结束识别**:
   - 必须发送 `{"end": true, "sessionId": "xxx"}` 格式的结束标识
   - `sessionId` 由后端生成并返回给前端

5. **错误处理**:
   - 连接失败时，前端应提示用户重试
   - 识别错误时，检查错误码并给出相应提示

## 与标准版的区别

| 特性 | 标准版 | 大模型版 |
|------|--------|----------|
| WebSocket URL | `wss://rtasr.xfyun.cn/v1/ws` | `wss://office-api-ast-dx.iflyaisol.com/ast/communicate/v1` |
| 认证参数 | appid, ts, signa | appId, accessKeyId, utc, signature |
| 签名算法 | HmacSHA1(MD5(appid+ts), apiKey) | HmacSHA1(baseString, accessKeySecret) |
| 语言支持 | 中文、中英混合、英文 | 中英+202种方言、37个语种 |
| 结束标识 | `{"end": true}` | `{"end": true, "sessionId": "xxx"}` |
| 返回格式 | action/result/error | msg_type/res_type |

## 更新日志

- **v2.0.0** (2025-01-XX): 切换到讯飞大模型版本
  - 支持中英+202种方言免切识别
  - 支持37个语种免切识别
  - 改进的签名算法
  - 需要 sessionId 的结束标识

