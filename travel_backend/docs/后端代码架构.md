# ğŸ—ï¸ AI æ™ºèƒ½æ—…è¡Œè§„åˆ’é¡¹ç›® - Python åç«¯ä»£ç ç»„ç»‡æ¶æ„è®¾è®¡

æœ¬é¡¹ç›®é‡‡ç”¨ **FastAPI** æ¡†æ¶å’Œ **åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰** åŸåˆ™è¿›è¡Œç»„ç»‡ï¼Œç¡®ä¿é«˜å†…èšã€ä½è€¦åˆã€‚

## 1. é¡¶å±‚æ–‡ä»¶ä¸é…ç½®

| æ–‡ä»¶/æ–‡ä»¶å¤¹ | èŒè´£ | æè¿° |
| :--- | :--- | :--- |
| `main.py` | **åº”ç”¨å…¥å£** | åˆå§‹åŒ– FastAPI åº”ç”¨å®ä¾‹ï¼Œå¯¼å…¥å¹¶æ³¨å†Œ `/api` ç›®å½•ä¸‹çš„æ‰€æœ‰è·¯ç”± (Routers)ï¼Œé…ç½®å…¨å±€ä¸­é—´ä»¶ã€‚ |
| `.env` | **ç¯å¢ƒå˜é‡** | å­˜å‚¨æ‰€æœ‰ API å¯†é’¥ã€æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€åº”ç”¨ Secret Key ç­‰æ•æ„Ÿä¿¡æ¯ã€‚ |
| `requirements.txt` | **ä¾èµ–åˆ—è¡¨** | è®°å½•é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰ Python åº“åŠå…¶ç‰ˆæœ¬ã€‚ |
| `/config` | **é…ç½®æ¨¡å—** | å­˜æ”¾åŠ è½½å’ŒéªŒè¯é…ç½®çš„é€»è¾‘ã€‚ |
| `config/settings.py` | é…ç½®ç±» | ä½¿ç”¨ Pydantic çš„ `BaseSettings` å®šä¹‰é…ç½®æ¨¡å‹ï¼Œä» `.env` å®‰å…¨åŠ è½½é…ç½®ã€‚ |

## 2. æ ¸å¿ƒæ¨¡å—ç»„ç»‡ (`/app`)

### 2.1. `/app/api` - æ¥å£å±‚ (Interface Layer / Routers)

**èŒè´£ï¼š** æ¥æ”¶å’Œå“åº” HTTP è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ä½“/è·¯å¾„å‚æ•°ï¼Œè°ƒç”¨æœåŠ¡å±‚ (Services)ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚

| æ–‡ä»¶ | èŒè´£ | å…³é”®æ¥å£æ–¹æ³• (FastAPI Routers) |
| :--- | :--- | :--- |
| `api/auth.py` | è®¤è¯è·¯ç”± | `login()`: ç”¨æˆ·ç™»å½•ï¼Œè¿”å› JWT Tokenã€‚<br>`register()`: ç”¨æˆ·æ³¨å†Œã€‚<br>`get_current_user()`: é€šè¿‡ Token è·å–ç”¨æˆ·èµ„æ–™ã€‚ |
| `api/plan.py` | è¡Œç¨‹è§„åˆ’è·¯ç”± | `create_plan_text()`: (POST) æ–‡æœ¬åˆ›å»ºè¡Œç¨‹ï¼Œè°ƒç”¨ `trip_service`ã€‚<br>`create_plan_voice()`: (POST) è¯­éŸ³æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†ã€‚<br>`get_trip_detail(trip_id)`: (GET) è·å–å•ä¸ªè¡Œç¨‹è¯¦æƒ…ã€‚ |
| `api/budget.py`| è´¹ç”¨ç®¡ç†è·¯ç”± | `record_expense_text()`: (POST) æ–‡æœ¬è®°å½•å¼€é”€ï¼Œè°ƒç”¨ `expense_service`ã€‚<br>`record_expense_voice()`: (POST) è¯­éŸ³è®°å½•å¼€é”€ã€‚<br>`get_trip_finance(trip_id)`: (GET) è·å–é¢„ç®—å’Œå®é™…å¼€é”€æŠ¥å‘Šã€‚ |

### 2.2. `/app/services` - æœåŠ¡å±‚ (Business Logic Layer)

**èŒè´£ï¼š** å°è£…å’Œæ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒæ•°æ®å±‚ (Data) å’Œå¤–éƒ¨ APIã€‚

| æ–‡ä»¶ | èŒè´£ | å…³é”®åŠŸèƒ½æ–¹æ³• (Python) |
| :--- | :--- | :--- |
| `services/trip_service.py` | **è¡Œç¨‹ä¸»æœåŠ¡** | `generate_full_itinerary()`: **(æ ¸å¿ƒ)** åè°ƒ AI/åœ°å›¾æœåŠ¡ï¼Œç”Ÿæˆå¹¶æŒä¹…åŒ–è¡Œç¨‹ã€‚<br>`update_trip()`: ä¸šåŠ¡é€»è¾‘éªŒè¯åçš„è¡Œç¨‹ä¿®æ”¹ã€‚<br>`get_trip_header_list()`: è·å–ç”¨æˆ·æ‰€æœ‰è¡Œç¨‹çš„æ¦‚è¦åˆ—è¡¨ã€‚ |
| `services/ai_service.py` | **AI æ ¸å¿ƒæœåŠ¡** | `parse_user_intent(text)`: (2.2) å°†è‡ªç„¶è¯­è¨€è½¬ä¸ºç»“æ„åŒ–è¾“å…¥ã€‚<br>`llm_plan_decision(user_data, poi_list)`: (3.2) LLM å†³ç­–è¡Œç¨‹å’Œäº¤é€šæ–¹å¼ã€‚<br>`estimate_budget(trip_details)`: (4.1) LLM é¢„ç®—ä¼°ç®—ã€‚ |
| `services/voice_service.py` | **è¯­éŸ³å¤„ç†** | `transcribe_audio(file)`: (2.1) è°ƒç”¨ç§‘å¤§è®¯é£ API è¿›è¡Œè¯­éŸ³è½¬æ–‡æœ¬ã€‚ |
| `services/map_service.py` | **åœ°å›¾æœåŠ¡** | `search_poi(destination, preference)`: (3.1) POI æ£€ç´¢ã€‚<br>`get_eta(point_a, point_b, mode)`: (3.3) è°ƒç”¨ API è·å–ä¸¤ç‚¹é—´çš„é¢„ä¼°è€—æ—¶ã€‚ |
| `services/expense_service.py`| **è´¹ç”¨æœåŠ¡** | `record_expense_transaction()`: å¤„ç†è´¹ç”¨è®°å½•çš„ä¸šåŠ¡é€»è¾‘ã€‚<br>`analyze_variance()`: (4.3) é¢„ç®—å¯¹æ¯”è®¡ç®—å’Œåˆ†æã€‚ |

### 2.3. `/app/data` - æ•°æ®å±‚ (Data Access Layer / Repository)

**èŒè´£ï¼š** å°è£…æ‰€æœ‰æ•°æ®åº“ï¼ˆSupabase/Firestoreï¼‰çš„ CRUD æ“ä½œï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“æŠ€æœ¯çš„éš”ç¦»ã€‚

| æ–‡ä»¶ | èŒè´£ | å…³é”®åŠŸèƒ½æ–¹æ³• (Python) |
| :--- | :--- | :--- |
| `data/database.py` | **DB è¿æ¥** | `get_db_session()`: åˆå§‹åŒ–æ•°æ®åº“è¿æ¥å’Œä¼šè¯ä¾èµ–æ³¨å…¥ã€‚ |
| `data/trip_repository.py` | è¡Œç¨‹æ•°æ®è®¿é—® | `create_trip()`, `save_trip_details()`, `get_trip_by_id()` ç­‰ CRUD æ“ä½œã€‚ |
| `data/user_repository.py` | ç”¨æˆ·æ•°æ®è®¿é—® | `create_user()`, `get_user_by_email()`, `update_user_preferences()`ã€‚ |
| `data/expense_repository.py` | è´¹ç”¨æ•°æ®è®¿é—® | `add_new_expense()`, `get_expenses_by_trip()`, `get_budget_by_trip()`ã€‚ |

### 2.4. `/app/models` - æ•°æ®æ¨¡å‹å±‚

**èŒè´£ï¼š** å­˜æ”¾é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ•°æ®ç»“æ„å®šä¹‰ã€‚

| æ–‡ä»¶ | èŒè´£ | å…³é”®ç±» (Pydantic / ORM) |
| :--- | :--- | :--- |
| `models/api_models.py` | **API æ•°æ®ç»“æ„** | `TripInput`, `ExpenseInput`, `LoginRequest`, ç”¨äºæ¥å£çš„è¯·æ±‚å’Œå“åº”ã€‚ |
| `models/db_models.py` | **æ•°æ®åº“ ORM** | `User`, `TripHeader`, `TripDetail`, `Budget`, `Expense` (ä½¿ç”¨ SQLAlchemy/Supabase ORM å®šä¹‰)ã€‚ |
| `models/llm_models.py` | **LLM è¾“å‡ºç»“æ„** | `DailyPlan`, `Activity`, `BudgetCategory` (ä¸¥æ ¼å¯¹åº” LLM çš„ JSON è¾“å‡ºç»“æ„)ã€‚ |

## 3. ä»£ç ç»„ç»‡ç»“æ„å›¾
```
travel_planner_backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/             # æ¥å£å±‚ (Routers)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ plan.py
â”‚   â”‚   â””â”€â”€ budget.py
â”‚   â”œâ”€â”€ services/        # ä¸šåŠ¡é€»è¾‘å±‚ (Services)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ trip_service.py  (ä¸»åè°ƒæœåŠ¡)
â”‚   â”‚   â”œâ”€â”€ ai_service.py    (LLM äº¤äº’)
â”‚   â”‚   â”œâ”€â”€ map_service.py   (åœ°å›¾ API äº¤äº’)
â”‚   â”‚   â””â”€â”€ expense_service.py
â”‚   â”œâ”€â”€ data/            # æ•°æ®è®¿é—®å±‚ (Repository)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ database.py    (DB è¿æ¥é…ç½®)
â”‚   â”‚   â”œâ”€â”€ trip_repository.py
â”‚   â”‚   â””â”€â”€ user_repository.py
â”‚   â””â”€â”€ models/          # æ•°æ®æ¨¡å‹å±‚ (Schema)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ api_models.py
â”‚       â”œâ”€â”€ db_models.py
â”‚       â””â”€â”€ llm_models.py
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py      # é…ç½®ç®¡ç†
â”œâ”€â”€ main.py              # åº”ç”¨å…¥å£
â”œâ”€â”€ .env                 # ç¯å¢ƒå˜é‡
â””â”€â”€ requirements.txt     # ä¾èµ–åˆ—è¡¨
```